<!DOCTYPE html>
<html lang="ru-RU">

<head>
    <meta charset="UTF-8">
    <title>Редактирование</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>

<body>
    <form style="width: 450px; margin: 0 auto;" id="SendForm">
        <h5 id="NameL">Редактирование: ...</h5>
        <label for="files">Аватарка:</label>
        <input type="file" id="files" name="files" accept=".jpg, .png, .jpeg, .gif, .bmp, .tif, .tiff|image/*">
        <h5 id="Mail">Почта (неизменно): ...</h5>
        <div class="formel">
            <label for="Name">ФИО*</label>
            <input type="text" class="form-control" id="Name" name="Name" placeholder="Неизвестно" minlength="9"
                maxlength="50" required value="">
        </div>
        <div class="formel">
            <label for="Pass">Пароль*</label>
            <input type="text" class="form-control" id="Pass" name="Pass" placeholder="Да подлиннее" minlength="6"
                maxlength="50" required>
        </div>
        <div class="formel">
            <label for="Mail2">Дополнительная почта</label>
            <input type="email" id="Mail2" name="Mail2" class="form-control" placeholder="example@gmail.com"
                minlength="9" maxlength="50" value="">
        </div>
        <div class="formel">
            <label for="Info">Информация о вас</label>
            <textarea class="form-control" id="Info" name="Info" placeholder="Информация о вас" value=""></textarea>
        </div>
        <div class="formel">
            <label for="Achiv">Дополнительные достижения</label>
            <textarea class="form-control" id="Achiv" name="Achiv" placeholder="Впишите всё, что есть"
                value=""></textarea>
        </div>
        <div class="formel" style="display: flex;justify-content: space-between;">
            <button type="button" class="btn btn-info" onclick="location.href='/'">Назад</button>
            <button type="submit" class="btn btn-info" id="Send">Применить</button>
        </div>
    </form>
    <script>

        let url = window.location.href;
        let ID = 0;
        console.log(url.replace("/edit", "/"));
        let r = fetch(url.replace("/edit", "/"));
        let rr = r.then((res) => { console.log(res); return res.json(); });
        rr.then((data) => {
            console.log(data);
            //console.log(data.data.length);
            if (data.status == 0) {
                ID = data.data[0].ID;
                document.getElementById("NameL").textContent = "Редактирование: " + data.data[0].Name + " [" + ID + "]";
                document.getElementById("Mail").textContent = "Почта (неизменно): " + data.data[0].Email;
                document.getElementById("Name").value = data.data[0].Name;
                document.getElementById("Pass").value = data.data[0].Pass;
                document.getElementById("Mail2").value = data.data[0].EmailSec;
                document.getElementById("Info").value = data.data[0].Info;
                document.getElementById("Achiv").value = data.data[0].Achievements;
            }
        });

        document.getElementById("Send").addEventListener("click", function (e) {
            if (
                document.getElementById("Name").validity.valid
                && document.getElementById("Mail2").validity.valid
                && document.getElementById("Info").validity.valid
                && document.getElementById("Pass").validity.valid
                && document.getElementById("Achiv").validity.valid
            ) {
                //  method="POST" enctype="multipart/form-data"
/*
                let registerForm = document.forms["SendForm"];

                let Name = registerForm.elements["Name"].value;
                let Mail2 = registerForm.elements["Mail2"].value;
                let Info = registerForm.elements["Info"].value;
                let Pass = registerForm.elements["Pass"].value;
                let Achiv = registerForm.elements["Achiv"].value;

                let user = JSON.stringify({ ID: ID, Name: Name, Mail2: Mail2, Info: Info, Pass: Pass, Achiv: Achiv, UUID: localStorage.getItem('sess_id') });
                let request = new XMLHttpRequest();
                request.open("put", "/users/" + ID, true);
                request.setRequestHeader("Content-Type", "application/json");
                request.addEventListener("load", function () {
                    let receivedUser = JSON.parse(request.response);
                    console.log("ответ: " + request.response);
                    let S = receivedUser.status;
                    if (S == 0) {
                        //успешно отправлено
                        window.location = '/';
                    }
                    else {
                        if (S == 255) console.log("Неизвестная ошибка при отправке.");
                        if (S == 1) console.log("Ошибка в базе данных.");
                    }
                });
                console.log(user);
                request.send(user);
                e.preventDefault();

*/
                let registerForm = document.forms["SendForm"];
                const formData = new FormData(registerForm);
                formData.append("UUID", localStorage.getItem('sess_id'));
                const xhr = new XMLHttpRequest();
                xhr.onload = () => {
                    console.log(JSON.parse(xhr.response));
                    let S = xhr.response.status;
                    if (S == 0) {
                        //успешно отправлено
                        window.location = '/';
                    }
                    else {
                        if (S == 255) console.log("Неизвестная ошибка при отправке.");
                        if (S == 1) console.log("Ошибка в базе данных.");
                    }
                };
                xhr.open('PUT', "/users/" + ID);
                xhr.send(formData);




            }
        });
    </script>
</body>

</html>