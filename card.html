<!DOCTYPE html>
<html>

<head>
    <title>Пользователь</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <meta charset="utf-8" />
    <script src="http://threejs.org/build/three.min.js"></script>
    <script src="http://localhost:3000/STLLoader.js"></script>
</head>

<body>
    <header>
        <div>
            <button type="button" class="btn btn-info" style="margin: 10px 10px;"
                onclick="location.href='/'">Назад</button>
        </div>
        <div id="Header">
            <button type="button" class="btn btn-info" style="margin: 10px 10px"
                onclick="location.href='/reg'">Регистрация</button>
        </div>
    </header>
    <script>
        var counter = 0;
        function Add() { window.counter++; if (window.counter == 2) Final() };
        let head = document.getElementById("Header");
        let uuid = localStorage.getItem('sess_id');
        var GottenID = undefined;
        if (uuid == undefined) uuid = 0;
        console.log(uuid);
        if (uuid != 0) {
            let request = new XMLHttpRequest();
            request.open("post", "/users/check1", true);
            let user = JSON.stringify({ UUID: uuid });
            request.setRequestHeader("Content-Type", "application/json");
            request.addEventListener("load", function () {
                let receivedUser = JSON.parse(request.response);
                console.log("ответ От check1: " + request.response);
                let S = receivedUser.status;
                if (S == 0) {
                    //успешно получен ид
                    GottenID = receivedUser.data[0].ID;
                    console.log("получили ID: " + GottenID);
                    head.insertAdjacentHTML('afterBegin', `<button type="button" class="btn btn-info" style="margin: 10px 10px" onclick="location.href='/users/` + GottenID + `/view'">` + receivedUser.data[0].Name + `</button>`);
                    head.insertAdjacentHTML('afterBegin', `<img src="/UsersLogo/` + GottenID + `" width="40px" height="40px" style="align-self: center;" alt="UserPhotoSmall" onerror="ImgReload()" id="PhotoSmall">`)
                }
                else {
                    localStorage.setItem('sess_id', 0);//раз значение сессии не найдено (мб оно стерлось за это время), то вообще сбрасываем до 0.
                    head.insertAdjacentHTML('afterBegin', `<button type="button" class="btn btn-info" style="margin: 10px 10px" onclick="location.href='/login'">Войти</button>`);
                }
                Add();
            });
            console.log(user);
            request.send(user);
        }
        else {
            head.insertAdjacentHTML('afterBegin', `<button type="button" class="btn btn-info" style="margin: 10px 10px" onclick="location.href='/login'">Войти</button>`);
        }
    </script>
    <div id="DIV" style="display: flex; margin: 10px auto; justify-content: center ">
        <div style="margin: 10px 10px" id="All">
            <h1 id="NameL">... [...]</h1>
            <h3>Описание</h3>
            <p id="Text">...</p>
        </div>
    </div>
    <script>
        let r = fetch(window.location.href.replace("/view", "/"));
        let rr = r.then((res) => { console.log(res); return res.json(); });
        let aID = 0;
        let ID = 0;
        rr.then((data) => {
            console.log(data);
            console.log(data.data.length);
            if (data.data.length > 0) {
                ID = data.data[0].ID;
                aID = data.data[0].AuthorID;
                document.getElementById("NameL").textContent = data.data[0].Name + " [" + ID + "]";
                document.getElementById("Text").innerHTML = data.data[0].FullText;
                ShowModel(data.data[0].FileName, data.data[0].Ext);
            }
            Add();
        });
        function Final() {

            console.log(window.GottenID + " " + aID);
            if (window.GottenID != undefined) {
                document.getElementById("All").insertAdjacentHTML('beforeEnd', `<button type="submit" class="btn btn-info" id="Add">Добавить в отложенное</button>`);
                document.getElementById("Add").onclick = function (e) {
                    let request = new XMLHttpRequest();
                    let user = JSON.stringify({ ID: ID, UUID: uuid });
                    request.open("post", "/cards/add", true);
                    request.setRequestHeader("Content-Type", "application/json");
                    request.addEventListener("load", function () {
                        let receivedUser = JSON.parse(request.response);
                        console.log("ответ: " + request.response);
                        let S = receivedUser.status;
                        if (S == 0) {
                            //успешно отправлено
                            window.location = '/';
                        }
                        else {
                            if (S == 255) console.log("Неизвестная ошибка при отправке.");
                            if (S == 1) console.log("Ошибка в базе данных.");
                        }
                    });
                    console.log(user);
                    request.send(user);
                    e.preventDefault();
                }
            }
            if (window.GottenID == aID) {
                document.getElementById("All").insertAdjacentHTML('beforeEnd', `
            <button type="submit" class="btn btn-info" id="Delete">Удалить карточку</button>
            <button type="submit" class="btn btn-info" id="Edit" onclick="location.href = '/cards/' + ID + '/edit'">Редактировать карточку</button>
                `);
                document.getElementById("Delete").onclick = function (e) {
                    let request = new XMLHttpRequest();
                    let user = JSON.stringify({ ID: ID, UUID: uuid });
                    request.open("delete", "/cards/" + ID, true);
                    request.setRequestHeader("Content-Type", "application/json");
                    request.addEventListener("load", function () {
                        let receivedUser = JSON.parse(request.response);
                        console.log("ответ: " + request.response);
                        let S = receivedUser.status;
                        if (S == 0) {
                            //успешно отправлено
                            window.location = '/';
                        }
                        else {
                            if (S == 255) console.log("Неизвестная ошибка при отправке.");
                            if (S == 1) console.log("Ошибка в базе данных.");
                        }
                    });
                    console.log(user);
                    request.send(user);
                    e.preventDefault();
                }
            }

        }

        var scene;
        var camera;
        var renderer;
        var mesh;
        function ShowModel(id, ext) {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.z = 10;
            scene.add(camera);
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(400, 400);
            document.getElementById("DIV").appendChild(renderer.domElement);
            let loader = new THREE.STLLoader();
            //ext: OBJ / STL
            loader.load('/Models/' + id, function (geometry) {
                console.log("имя файла: " + id + ", расш. " + ext);
                let material = new THREE.MeshPhongMaterial({ color: 0xff00ff });
                mesh = new THREE.Mesh(geometry, material);
                let box = new THREE.Box3();
                let size = new THREE.Vector3();
                box.setFromObject(mesh).getSize(size);
                mesh.scale.set(1/size.y,1/size.y,1/size.y);
                scene.add(mesh);
            });
            
/*/ create a geometry
const geometry2 = new THREE.BoxGeometry(2, 2, 2);

// create a default (white) Basic material
const material2 = new THREE.MeshBasicMaterial({color: 0x00ffff });

// create a Mesh containing the geometry and material
const cube2 = new THREE.Mesh(geometry2, material2);;

// add the mesh to the scene
scene.add(cube2);
*/
scene.background = new THREE.Color(0x423432 );


            window.addEventListener('resize', onWindowResize, false);
            //onWindowResize();
            //render();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.render(scene, camera);
        }

        function animate(){
            requestAnimationFrame(animate);
            render();
        }

        function render() {
            mesh.rotation.x += 0.01;
            mesh.rotation.y += 0.01;
            renderer.render(scene, camera);
        }

        animate();
    </script>
</body>

</html>