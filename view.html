<!DOCTYPE html>
<html>

<head>
    <title>Пользователь</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <meta charset="utf-8" />
</head>

<body>
    <header>
        <div>
            <button type="button" class="btn btn-info" style="margin: 10px 10px;"
                onclick="location.href='/'">Назад</button>
        </div>
        <div id="Header">
            <button type="button" class="btn btn-info" style="margin: 10px 10px"
                onclick="location.href='/reg'">Регистрация</button>
        </div>
    </header>
    <script>
        let head = document.getElementById("Header");
        let uuid = localStorage.getItem('sess_id');
        var GottenID = undefined;
        var counter = 0;
        if (uuid == undefined) uuid = 0;
        console.log(uuid);
        if (uuid != 0) {
            let request = new XMLHttpRequest();
            request.open("post", "/users/check1", true);
            let user = JSON.stringify({ UUID: uuid });
            request.setRequestHeader("Content-Type", "application/json");
            request.addEventListener("load", function () {
                let receivedUser = JSON.parse(request.response);
                console.log("ответ От check1: " + request.response);
                let S = receivedUser.status;
                if (S == 0) {
                    //успешно получен ид
                    GottenID = receivedUser.data[0].ID;
                    console.log("получили ID: " + GottenID);
                    head.insertAdjacentHTML('afterBegin', `<button type="button" class="btn btn-info" style="margin: 10px 10px" onclick="location.href='/users/` + GottenID + `/view'">` + receivedUser.data[0].Name + `</button>`);
                    head.insertAdjacentHTML('afterBegin', `<img src="/UsersLogo/` + GottenID + `" width="40px" height="40px" style="align-self: center;" alt="UserPhotoSmall" onerror="ImgReload()" id="PhotoSmall">`)
                }
                else {
                    GottenID = null;
                    localStorage.setItem('sess_id', 0);//раз значение сессии не найдено (мб оно стерлось за это время), то вообще сбрасываем до 0.
                    head.insertAdjacentHTML('afterBegin', `<button type="button" class="btn btn-info" style="margin: 10px 10px" onclick="location.href='/login'">Войти</button>`);
                }
                Add();
            });
            console.log(user);
            request.send(user);
        }
        else {
            head.insertAdjacentHTML('afterBegin', `<button type="button" class="btn btn-info" style="margin: 10px 10px" onclick="location.href='/login'">Войти</button>`);
        }
    </script>
    <div style="display: flex;justify-content: space-around;flex-wrap: wrap;">
        <div class="user_div" id="UserPart">
            <h1 id="NameL">... [...]</h1>
            <img src="/UsersLogo/empty.png" width="300px" height="300px" alt="UserPhoto" onerror="ImgReload()"
                id="Photo">
            <h3>Контакты</h3>
            <p id="Mail">Почта: ...</p>
            <p id="Mail2">Доп. почта: ...</p>
            <h4>Информация</h4>
            <p id="Info">...</p>
            <h4>Дополнительные достижения</h4>
            <p id="Achiv">...</p>
        </div>
        <div class="user_div" id="CardsPart">
            <h4>Добавленные карточки</h4>
            <div id="CardsList" style="max-height: 600px; overflow-y: auto;">

            </div>
        </div>
    </div>
    <h4>Отложенные карточки</h4>
    <hr>
    <div id="LikedCardsList">
    </div>
    <script>
        function ImgReload() { document.getElementById("Photo").src = "/UsersLogo/empty.png"; }
        let url = window.location.href;
        let ID = 0;
        console.log(url.replace("/view", "/"));
        let r = fetch(url.replace("/view", "/"));
        let rr = r.then((res) => { console.log(res); return res.json(); });
        rr.then((data) => {
            console.log(data);
            console.log(data.data.length);
            if (data.status == 0) {
                ID = data.data[0].ID;
                document.getElementById("Photo").src = "/UsersLogo/" + ID;
                document.getElementById("NameL").textContent = data.data[0].Name + " [" + ID + "]";
                document.getElementById("Mail").innerHTML = "Почта: " + data.data[0].Email;
                document.getElementById("Mail2").innerHTML = "Доп. почта: " + (data.data[0].EmailSec == "" ? "не указана." : data.data[0].EmailSec);
                document.getElementById("Info").innerHTML = (data.data[0].Info == "" ? "Пользователь не предоставил информацию о себе." : data.data[0].Info);
                document.getElementById("Achiv").innerHTML = (data.data[0].Achievements == "" ? "Пользователь не предоставил своих достижений." : data.data[0].Achievements);

                let req = fetch("http://localhost:3000/cards/all?likedby=" + ID);
                let reqr = req.then((ress) => { console.log(ress); return ress.json(); });
                reqr.then((data) => {
                    console.log("понравившиеся: " + JSON.stringify(data.data));
                    console.log("понравившиеся: " + data.data.length);
                    if (data.data.length > 0) {
                        let list = document.getElementById("LikedCardsList");
                        for (let i = 0; i < data.data.length; i++)
                            list.insertAdjacentHTML('afterend',
                                "<div class=\"card\"><div class=\"cardin\"><div><p class=\"card_client_title\">"
                                + data.data[i].Name + "</p><p class=\"card_client_mail\">"
                                + data.data[i].SmallText
                                + "</p></div><div style=\"margin: 10px;\"><button type=\"button\" class=\"btn btn-info\" onclick=\"location.href='/cards/" + data.data[i].ID + "/view'\">Посмотреть карточку</button></div></div></div>");

                    }
                });
            }
            Add();
        });

        function Add() { window.counter++; if (window.counter == 2) Final(); }
        function Final() {

            let req = fetch("http://localhost:3000/cards/all?author=" + ID);
            let reqr = req.then((ress) => { console.log(ress); return ress.json(); });
            reqr.then((data) => {
                console.log(data);
                console.log(data.data.length);
                if (data.data.length > 0) {
                    let list = document.getElementById("CardsList");
                    for (let i = 0; i < data.data.length; i++)
                        list.insertAdjacentHTML('afterend',
                            "<div class=\"card\"><div class=\"cardin\"><div><p class=\"card_client_title\">"
                            + data.data[i].Name + "</p><p class=\"card_client_mail\">"
                            + data.data[i].SmallText
                            + "</p></div><div style=\"margin: 10px;\"><button type=\"button\" class=\"btn btn-info\" onclick=\"location.href='/cards/" + data.data[i].ID + "/view'\">Посмотреть карточку</button></div></div></div>");

                }
            });

            console.log(window.GottenID + " " + ID);
            if (window.GottenID == ID) {
                document.getElementById("UserPart").insertAdjacentHTML('beforeEnd', `
            <button type="submit" class="btn btn-info" id="Logout">Выйти</button>
            <button type="submit" class="btn btn-info" id="Delete">Удалить профиль</button>
            <button type="submit" class="btn btn-info" id="Edit" onclick="location.href = '/users/' + ID + '/edit'">Редактировать профиль</button>
                `);
                document.getElementById("CardsPart").insertAdjacentHTML('beforeEnd', `
            <button type="submit" class="btn btn-info" id="Add" onclick="location.href = '/add_card'">Добавить карточку</button>
                `);
                document.getElementById("Delete").onclick = function (e) {
                    let request = new XMLHttpRequest();
                    let user = JSON.stringify({ ID: ID });
                    request.open("delete", "/users/" + ID, true);
                    request.setRequestHeader("Content-Type", "application/json");
                    request.addEventListener("load", function () {
                        let receivedUser = JSON.parse(request.response);
                        console.log("ответ: " + request.response);
                        let S = receivedUser.status;
                        if (S == 0) {
                            //успешно отправлено
                            window.location = '/';
                        }
                        else {
                            if (S == 255) console.log("Неизвестная ошибка при отправке.");
                            if (S == 1) console.log("Ошибка в базе данных.");
                        }
                    });
                    console.log(user);
                    request.send(user);
                    e.preventDefault();
                }
                document.getElementById("Logout").onclick = function (e) {
                    let request = new XMLHttpRequest();
                    let user = JSON.stringify({ UUID: uuid });
                    request.open("post", "/users/logout", true);
                    request.setRequestHeader("Content-Type", "application/json");
                    request.addEventListener("load", function () {
                        let receivedUser = JSON.parse(request.response);
                        console.log("ответ: " + request.response);
                        let S = receivedUser.status;
                        if (S == 0) {
                            //успешно отправлено
                            window.location = '/';
                        }
                        else {
                            if (S == 255) console.log("Неизвестная ошибка при отправке.");
                            if (S == 1) console.log("Ошибка в базе данных.");
                        }
                    });
                    console.log(user);
                    request.send(user);
                    localStorage.setItem('sess_id', 0);
                    e.preventDefault();
                }
            }
        }
    </script>
</body>

</html>